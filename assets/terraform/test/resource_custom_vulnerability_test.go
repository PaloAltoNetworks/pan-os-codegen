package provider_test

import (
	"fmt"
	"strconv"
	"testing"

	"github.com/hashicorp/terraform-plugin-testing/config"
	"github.com/hashicorp/terraform-plugin-testing/helper/acctest"
	"github.com/hashicorp/terraform-plugin-testing/helper/resource"
	"github.com/hashicorp/terraform-plugin-testing/knownvalue"
	"github.com/hashicorp/terraform-plugin-testing/statecheck"
	"github.com/hashicorp/terraform-plugin-testing/tfjsonpath"
)

func TestAccCustomVulnerability_DefaultActionAlert(t *testing.T) {
	t.Parallel()

	nameSuffix := acctest.RandStringFromCharSet(6, acctest.CharSetAlphaNum)
	prefix := fmt.Sprintf("test-acc-%s", nameSuffix)

	name := acctest.RandIntRange(41000, 45000)

	location := config.ObjectVariable(map[string]config.Variable{
		"device_group": config.ObjectVariable(map[string]config.Variable{
			"name": config.StringVariable(prefix),
		}),
	})

	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProviders,
		Steps: []resource.TestStep{
			{
				Config: customVulnerability_DefaultActionAlert_Tmpl,
				ConfigVariables: map[string]config.Variable{
					"prefix":   config.StringVariable(prefix),
					"name":     config.IntegerVariable(name),
					"location": location,
				},
				ConfigStateChecks: []statecheck.StateCheck{
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("name"),
						knownvalue.StringExact(strconv.Itoa(name)),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("default_action"),
						knownvalue.ObjectExact(map[string]knownvalue.Check{
							"alert":        knownvalue.ObjectExact(map[string]knownvalue.Check{}),
							"allow":        knownvalue.Null(),
							"block_ip":     knownvalue.Null(),
							"drop":         knownvalue.Null(),
							"reset_both":   knownvalue.Null(),
							"reset_client": knownvalue.Null(),
							"reset_server": knownvalue.Null(),
						}),
					),
				},
			},
		},
	})
}

const customVulnerability_DefaultActionAlert_Tmpl = `
variable "prefix" { type = string }
variable "name" { type = number }
variable "location" { type = any }

resource "panos_device_group" "example" {
	location = { panorama = {} }
	name = var.prefix
}

resource "panos_custom_vulnerability" "example" {
	depends_on = [panos_device_group.example]
	location = var.location
	name = var.name
	threatname = "threat"
	severity = "low"
	default_action = {
		alert = {}
	}
	signature = {
		standard = [{
			name = "std"
			and_condition = [{
				name = "and"
				or_condition = [{
					name = "or"
					operator = {
						pattern_match = {
							context = "http-req-uri-path"
							pattern = "foo"
						}
					}
				}]
			}]
		}]
	}
}
`

func TestAccCustomVulnerability_DefaultActionAllow(t *testing.T) {
	t.Parallel()

	nameSuffix := acctest.RandStringFromCharSet(6, acctest.CharSetAlphaNum)
	prefix := fmt.Sprintf("test-acc-%s", nameSuffix)

	name := acctest.RandIntRange(41000, 45000)

	location := config.ObjectVariable(map[string]config.Variable{
		"device_group": config.ObjectVariable(map[string]config.Variable{
			"name": config.StringVariable(prefix),
		}),
	})

	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProviders,
		Steps: []resource.TestStep{
			{
				Config: customVulnerability_DefaultActionAllow_Tmpl,
				ConfigVariables: map[string]config.Variable{
					"prefix":   config.StringVariable(prefix),
					"name":     config.IntegerVariable(name),
					"location": location,
				},
				ConfigStateChecks: []statecheck.StateCheck{
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("name"),
						knownvalue.StringExact(strconv.Itoa(name)),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("default_action"),
						knownvalue.ObjectExact(map[string]knownvalue.Check{
							"alert":        knownvalue.Null(),
							"allow":        knownvalue.ObjectExact(map[string]knownvalue.Check{}),
							"block_ip":     knownvalue.Null(),
							"drop":         knownvalue.Null(),
							"reset_both":   knownvalue.Null(),
							"reset_client": knownvalue.Null(),
							"reset_server": knownvalue.Null(),
						}),
					),
				},
			},
		},
	})
}

const customVulnerability_DefaultActionAllow_Tmpl = `
variable "prefix" { type = string }
variable "name" { type = number }
variable "location" { type = any }

resource "panos_device_group" "example" {
	location = { panorama = {} }
	name = var.prefix
}

resource "panos_custom_vulnerability" "example" {
	depends_on = [panos_device_group.example]
	location = var.location
	name = var.name
	threatname = "threat"
	severity = "low"
	default_action = {
		allow = {}
	}
	signature = {
		standard = [{
			name = "std"
			and_condition = [{
				name = "and"
				or_condition = [{
					name = "or"
					operator = {
						pattern_match = {
							context = "http-req-uri-path"
							pattern = "foo"
						}
					}
				}]
			}]
		}]
	}
}
`

func TestAccCustomVulnerability_DefaultActionBlockIp(t *testing.T) {
	t.Parallel()

	nameSuffix := acctest.RandStringFromCharSet(6, acctest.CharSetAlphaNum)
	prefix := fmt.Sprintf("test-acc-%s", nameSuffix)

	name := acctest.RandIntRange(41000, 45000)

	location := config.ObjectVariable(map[string]config.Variable{
		"device_group": config.ObjectVariable(map[string]config.Variable{
			"name": config.StringVariable(prefix),
		}),
	})

	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProviders,
		Steps: []resource.TestStep{
			{
				Config: customVulnerability_DefaultActionBlockIp_Tmpl,
				ConfigVariables: map[string]config.Variable{
					"prefix":   config.StringVariable(prefix),
					"name":     config.IntegerVariable(name),
					"location": location,
				},
				ConfigStateChecks: []statecheck.StateCheck{
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("name"),
						knownvalue.StringExact(strconv.Itoa(name)),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("default_action"),
						knownvalue.ObjectExact(map[string]knownvalue.Check{
							"alert": knownvalue.Null(),
							"allow": knownvalue.Null(),
							"block_ip": knownvalue.ObjectExact(map[string]knownvalue.Check{
								"duration": knownvalue.Int64Exact(10),
								"track_by": knownvalue.StringExact("source"),
							}),
							"drop":         knownvalue.Null(),
							"reset_both":   knownvalue.Null(),
							"reset_client": knownvalue.Null(),
							"reset_server": knownvalue.Null(),
						}),
					),
				},
			},
		},
	})
}

const customVulnerability_DefaultActionBlockIp_Tmpl = `
variable "prefix" { type = string }
variable "name" { type = number }
variable "location" { type = any }

resource "panos_device_group" "example" {
	location = { panorama = {} }
	name = var.prefix
}

resource "panos_custom_vulnerability" "example" {
	depends_on = [panos_device_group.example]
	location = var.location
	name = var.name
	threatname = "threat"
	severity = "low"
	default_action = {
		block_ip = {
			duration = 10
			track_by = "source"
		}
	}
	signature = {
		standard = [{
			name = "std"
			and_condition = [{
				name = "and"
				or_condition = [{
					name = "or"
					operator = {
						pattern_match = {
							context = "http-req-uri-path"
							pattern = "foo"
						}
					}
				}]
			}]
		}]
	}
}
`

func TestAccCustomVulnerability_DefaultActionDrop(t *testing.T) {
	t.Parallel()

	nameSuffix := acctest.RandStringFromCharSet(6, acctest.CharSetAlphaNum)
	prefix := fmt.Sprintf("test-acc-%s", nameSuffix)

	name := acctest.RandIntRange(41000, 45000)

	location := config.ObjectVariable(map[string]config.Variable{
		"device_group": config.ObjectVariable(map[string]config.Variable{
			"name": config.StringVariable(prefix),
		}),
	})

	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProviders,
		Steps: []resource.TestStep{
			{
				Config: customVulnerability_DefaultActionDrop_Tmpl,
				ConfigVariables: map[string]config.Variable{
					"prefix":   config.StringVariable(prefix),
					"name":     config.IntegerVariable(name),
					"location": location,
				},
				ConfigStateChecks: []statecheck.StateCheck{
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("name"),
						knownvalue.StringExact(strconv.Itoa(name)),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("default_action"),
						knownvalue.ObjectExact(map[string]knownvalue.Check{
							"alert":        knownvalue.Null(),
							"allow":        knownvalue.Null(),
							"block_ip":     knownvalue.Null(),
							"drop":         knownvalue.ObjectExact(map[string]knownvalue.Check{}),
							"reset_both":   knownvalue.Null(),
							"reset_client": knownvalue.Null(),
							"reset_server": knownvalue.Null(),
						}),
					),
				},
			},
		},
	})
}

const customVulnerability_DefaultActionDrop_Tmpl = `
variable "prefix" { type = string }
variable "name" { type = number }
variable "location" { type = any }

resource "panos_device_group" "example" {
	location = { panorama = {} }
	name = var.prefix
}

resource "panos_custom_vulnerability" "example" {
	depends_on = [panos_device_group.example]
	location = var.location
	name = var.name
	threatname = "threat"
	severity = "low"
	default_action = {
		drop = {}
	}
	signature = {
		standard = [{
			name = "std"
			and_condition = [{
				name = "and"
				or_condition = [{
					name = "or"
					operator = {
						pattern_match = {
							context = "http-req-uri-path"
							pattern = "foo"
						}
					}
				}]
			}]
		}]
	}
}
`

func TestAccCustomVulnerability_DefaultActionResetBoth(t *testing.T) {
	t.Parallel()

	nameSuffix := acctest.RandStringFromCharSet(6, acctest.CharSetAlphaNum)
	prefix := fmt.Sprintf("test-acc-%s", nameSuffix)

	name := acctest.RandIntRange(41000, 45000)

	location := config.ObjectVariable(map[string]config.Variable{
		"device_group": config.ObjectVariable(map[string]config.Variable{
			"name": config.StringVariable(prefix),
		}),
	})

	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProviders,
		Steps: []resource.TestStep{
			{
				Config: customVulnerability_DefaultActionResetBoth_Tmpl,
				ConfigVariables: map[string]config.Variable{
					"prefix":   config.StringVariable(prefix),
					"name":     config.IntegerVariable(name),
					"location": location,
				},
				ConfigStateChecks: []statecheck.StateCheck{
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("name"),
						knownvalue.StringExact(strconv.Itoa(name)),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("default_action"),
						knownvalue.ObjectExact(map[string]knownvalue.Check{
							"alert":        knownvalue.Null(),
							"allow":        knownvalue.Null(),
							"block_ip":     knownvalue.Null(),
							"drop":         knownvalue.Null(),
							"reset_both":   knownvalue.ObjectExact(map[string]knownvalue.Check{}),
							"reset_client": knownvalue.Null(),
							"reset_server": knownvalue.Null(),
						}),
					),
				},
			},
		},
	})
}

const customVulnerability_DefaultActionResetBoth_Tmpl = `
variable "prefix" { type = string }
variable "name" { type = number }
variable "location" { type = any }

resource "panos_device_group" "example" {
	location = { panorama = {} }
	name = var.prefix
}

resource "panos_custom_vulnerability" "example" {
	depends_on = [panos_device_group.example]
	location = var.location
	name = var.name
	threatname = "threat"
	severity = "low"
	default_action = {
		reset_both = {}
	}
	signature = {
		standard = [{
			name = "std"
			and_condition = [{
				name = "and"
				or_condition = [{
					name = "or"
					operator = {
						pattern_match = {
							context = "http-req-uri-path"
							pattern = "foo"
						}
					}
				}]
			}]
		}]
	}
}
`

func TestAccCustomVulnerability_DefaultActionResetClient(t *testing.T) {
	t.Parallel()

	nameSuffix := acctest.RandStringFromCharSet(6, acctest.CharSetAlphaNum)
	prefix := fmt.Sprintf("test-acc-%s", nameSuffix)

	name := acctest.RandIntRange(41000, 45000)

	location := config.ObjectVariable(map[string]config.Variable{
		"device_group": config.ObjectVariable(map[string]config.Variable{
			"name": config.StringVariable(prefix),
		}),
	})

	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProviders,
		Steps: []resource.TestStep{
			{
				Config: customVulnerability_DefaultActionResetClient_Tmpl,
				ConfigVariables: map[string]config.Variable{
					"prefix":   config.StringVariable(prefix),
					"name":     config.IntegerVariable(name),
					"location": location,
				},
				ConfigStateChecks: []statecheck.StateCheck{
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("name"),
						knownvalue.StringExact(strconv.Itoa(name)),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("default_action"),
						knownvalue.ObjectExact(map[string]knownvalue.Check{
							"alert":        knownvalue.Null(),
							"allow":        knownvalue.Null(),
							"block_ip":     knownvalue.Null(),
							"drop":         knownvalue.Null(),
							"reset_both":   knownvalue.Null(),
							"reset_client": knownvalue.ObjectExact(map[string]knownvalue.Check{}),
							"reset_server": knownvalue.Null(),
						}),
					),
				},
			},
		},
	})
}

const customVulnerability_DefaultActionResetClient_Tmpl = `
variable "prefix" { type = string }
variable "name" { type = number }
variable "location" { type = any }

resource "panos_device_group" "example" {
	location = { panorama = {} }
	name = var.prefix
}

resource "panos_custom_vulnerability" "example" {
	depends_on = [panos_device_group.example]
	location = var.location
	name = var.name
	threatname = "threat"
	severity = "low"
	default_action = {
		reset_client = {}
	}
	signature = {
		standard = [{
			name = "std"
			and_condition = [{
				name = "and"
				or_condition = [{
					name = "or"
					operator = {
						pattern_match = {
							context = "http-req-uri-path"
							pattern = "foo"
						}
					}
				}]
			}]
		}]
	}
}
`

func TestAccCustomVulnerability_DefaultActionResetServer(t *testing.T) {
	t.Parallel()

	nameSuffix := acctest.RandStringFromCharSet(6, acctest.CharSetAlphaNum)
	prefix := fmt.Sprintf("test-acc-%s", nameSuffix)

	name := acctest.RandIntRange(41000, 45000)

	location := config.ObjectVariable(map[string]config.Variable{
		"device_group": config.ObjectVariable(map[string]config.Variable{
			"name": config.StringVariable(prefix),
		}),
	})

	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProviders,
		Steps: []resource.TestStep{
			{
				Config: customVulnerability_DefaultActionResetServer_Tmpl,
				ConfigVariables: map[string]config.Variable{
					"prefix":   config.StringVariable(prefix),
					"name":     config.IntegerVariable(name),
					"location": location,
				},
				ConfigStateChecks: []statecheck.StateCheck{
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("name"),
						knownvalue.StringExact(strconv.Itoa(name)),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("default_action"),
						knownvalue.ObjectExact(map[string]knownvalue.Check{
							"alert":        knownvalue.Null(),
							"allow":        knownvalue.Null(),
							"block_ip":     knownvalue.Null(),
							"drop":         knownvalue.Null(),
							"reset_both":   knownvalue.Null(),
							"reset_client": knownvalue.Null(),
							"reset_server": knownvalue.ObjectExact(map[string]knownvalue.Check{}),
						}),
					),
				},
			},
		},
	})
}

const customVulnerability_DefaultActionResetServer_Tmpl = `
variable "prefix" { type = string }
variable "name" { type = number }
variable "location" { type = any }

resource "panos_device_group" "example" {
	location = { panorama = {} }
	name = var.prefix
}

resource "panos_custom_vulnerability" "example" {
	depends_on = [panos_device_group.example]
	location = var.location
	name = var.name
	threatname = "threat"
	severity = "low"
	default_action = {
		reset_server = {}
	}
	signature = {
		standard = [{
			name = "std"
			and_condition = [{
				name = "and"
				or_condition = [{
					name = "or"
					operator = {
						pattern_match = {
							context = "http-req-uri-path"
							pattern = "foo"
						}
					}
				}]
			}]
		}]
	}
}
`

func TestAccCustomVulnerability_SignatureCombination(t *testing.T) {
	t.Parallel()

	nameSuffix := acctest.RandStringFromCharSet(6, acctest.CharSetAlphaNum)
	prefix := fmt.Sprintf("test-acc-%s", nameSuffix)

	name := acctest.RandIntRange(41000, 45000)

	location := config.ObjectVariable(map[string]config.Variable{
		"device_group": config.ObjectVariable(map[string]config.Variable{
			"name": config.StringVariable(prefix),
		}),
	})

	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProviders,
		Steps: []resource.TestStep{
			{
				Config: customVulnerability_SignatureCombination_Tmpl,
				ConfigVariables: map[string]config.Variable{
					"prefix":   config.StringVariable(prefix),
					"name":     config.IntegerVariable(name),
					"location": location,
				},
				ConfigStateChecks: []statecheck.StateCheck{
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("name"),
						knownvalue.StringExact(strconv.Itoa(name)),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("signature"),
						knownvalue.ObjectExact(map[string]knownvalue.Check{
							"combination": knownvalue.ObjectExact(map[string]knownvalue.Check{
								"order_free": knownvalue.Bool(true),
								"time_attribute": knownvalue.ObjectExact(map[string]knownvalue.Check{
									"interval":  knownvalue.Int64Exact(10),
									"threshold": knownvalue.Int64Exact(20),
									"track_by":  knownvalue.StringExact("source"),
								}),
								"and_condition": knownvalue.ListExact([]knownvalue.Check{
									knownvalue.ObjectExact(map[string]knownvalue.Check{
										"name": knownvalue.StringExact("and"),
										"or_condition": knownvalue.ListExact([]knownvalue.Check{
											knownvalue.ObjectExact(map[string]knownvalue.Check{
												"name":      knownvalue.StringExact("or"),
												"threat_id": knownvalue.StringExact("10001"),
											}),
										}),
									}),
								}),
							}),
							"standard": knownvalue.Null(),
						}),
					),
				},
			},
		},
	})
}

const customVulnerability_SignatureCombination_Tmpl = `
variable "prefix" { type = string }
variable "name" { type = number }
variable "location" { type = any }

resource "panos_device_group" "example" {
	location = { panorama = {} }
	name = var.prefix
}

resource "panos_custom_vulnerability" "example" {
	depends_on = [panos_device_group.example]
	location = var.location
	name = var.name
	threatname = "threat"
	severity = "low"
	signature = {
		combination = {
			order_free = true
			time_attribute = {
				interval  = 10
				threshold = 20
				track_by  = "source"
			}
			and_condition = [{
				name = "and"
				or_condition = [{
					name      = "or"
					threat_id = "10001"
				}]
			}]
		}
	}
}
`

func TestAccCustomVulnerability_Basic(t *testing.T) {
	t.Parallel()

	nameSuffix := acctest.RandStringFromCharSet(6, acctest.CharSetAlphaNum)
	prefix := fmt.Sprintf("test-acc-%s", nameSuffix)

	name := acctest.RandIntRange(41000, 45000)

	location := config.ObjectVariable(map[string]config.Variable{
		"device_group": config.ObjectVariable(map[string]config.Variable{
			"name": config.StringVariable(prefix),
		}),
	})

	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProviders,
		Steps: []resource.TestStep{
			{
				Config: customVulnerability_Basic_Tmpl,
				ConfigVariables: map[string]config.Variable{
					"prefix":   config.StringVariable(prefix),
					"name":     config.IntegerVariable(name),
					"location": location,
				},
				ConfigStateChecks: []statecheck.StateCheck{
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("name"),
						knownvalue.StringExact(strconv.Itoa(name)),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("affected_host"),
						knownvalue.ObjectExact(map[string]knownvalue.Check{
							"client": knownvalue.Bool(true),
							"server": knownvalue.Bool(false),
						}),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("bugtraq"),
						knownvalue.ListExact([]knownvalue.Check{
							knownvalue.StringExact("bugtraq-id"),
						}),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("comment"),
						knownvalue.StringExact("comment"),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("cve"),
						knownvalue.ListExact([]knownvalue.Check{
							knownvalue.StringExact("cve-id"),
						}),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("direction"),
						knownvalue.StringExact("client2server"),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("reference"),
						knownvalue.ListExact([]knownvalue.Check{
							knownvalue.StringExact("http://some.reference.com"),
						}),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("severity"),
						knownvalue.StringExact("low"),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("threatname"),
						knownvalue.StringExact("threat"),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("vendor"),
						knownvalue.ListExact([]knownvalue.Check{
							knownvalue.StringExact("vendor-id"),
						}),
					),
				},
			},
		},
	})
}

const customVulnerability_Basic_Tmpl = `
variable "prefix" { type = string }
variable "name" { type = number }
variable "location" { type = any }

resource "panos_device_group" "example" {
	location = { panorama = {} }
	name = var.prefix
}

resource "panos_custom_vulnerability" "example" {
	depends_on = [panos_device_group.example]
	location = var.location
	name = var.name
	affected_host = {
		client = true
		server = false
	}
	bugtraq = ["bugtraq-id"]
	comment = "comment"
	cve = ["cve-id"]
	direction = "client2server"
	reference = ["http://some.reference.com"]
	severity = "low"
	threatname = "threat"
	vendor = ["vendor-id"]
	signature = {
		standard = [{
			name = "std"
			and_condition = [{
				name = "and"
				or_condition = [{
					name = "or"
					operator = {
						pattern_match = {
							context = "http-req-uri-path"
							pattern = "foo"
						}
					}
				}]
			}]
		}]
	}
}
`

func TestAccCustomVulnerability_DisableOverride(t *testing.T) {
	t.Parallel()

	nameSuffix := acctest.RandStringFromCharSet(6, acctest.CharSetAlphaNum)
	prefix := fmt.Sprintf("test-acc-%s", nameSuffix)

	name := acctest.RandIntRange(41000, 45000)

	location := config.ObjectVariable(map[string]config.Variable{
		"device_group": config.ObjectVariable(map[string]config.Variable{
			"name": config.StringVariable(prefix),
		}),
	})

	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProviders,
		Steps: []resource.TestStep{
			{
				Config: customVulnerability_DisableOverride_Tmpl,
				ConfigVariables: map[string]config.Variable{
					"prefix":   config.StringVariable(prefix),
					"name":     config.IntegerVariable(name),
					"location": location,
				},
				ConfigStateChecks: []statecheck.StateCheck{
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("name"),
						knownvalue.StringExact(strconv.Itoa(name)),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("disable_override"),
						knownvalue.StringExact("yes"),
					),
				},
			},
		},
	})
}

const customVulnerability_DisableOverride_Tmpl = `
variable "prefix" { type = string }
variable "name" { type = number }
variable "location" { type = any }

resource "panos_device_group" "example" {
	location = { panorama = {} }
	name = var.prefix
}

resource "panos_custom_vulnerability" "example" {
	depends_on = [panos_device_group.example]
	location = var.location
	name = var.name
	threatname = "threat"
	severity = "low"
	disable_override = "yes"
	signature = {
		standard = [{
			name = "std"
			and_condition = [{
				name = "and"
				or_condition = [{
					name = "or"
					operator = {
						pattern_match = {
							context = "http-req-uri-path"
							pattern = "foo"
						}
					}
				}]
			}]
		}]
	}
}
`

func TestAccCustomVulnerability_Signature_Standard_Scope(t *testing.T) {
	t.Parallel()

	nameSuffix := acctest.RandStringFromCharSet(6, acctest.CharSetAlphaNum)
	prefix := fmt.Sprintf("test-acc-%s", nameSuffix)

	name := acctest.RandIntRange(41000, 45000)

	location := config.ObjectVariable(map[string]config.Variable{
		"device_group": config.ObjectVariable(map[string]config.Variable{
			"name": config.StringVariable(prefix),
		}),
	})

	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProviders,
		Steps: []resource.TestStep{
			{
				Config: customVulnerability_Signature_Standard_Scope_Tmpl,
				ConfigVariables: map[string]config.Variable{
					"prefix":   config.StringVariable(prefix),
					"name":     config.IntegerVariable(name),
					"location": location,
				},
				ConfigStateChecks: []statecheck.StateCheck{
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("name"),
						knownvalue.StringExact(strconv.Itoa(name)),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("signature").AtMapKey("standard").AtSliceIndex(0).AtMapKey("scope"),
						knownvalue.StringExact("session"),
					),
				},
			},
		},
	})
}

const customVulnerability_Signature_Standard_Scope_Tmpl = `
variable "prefix" { type = string }
variable "name" { type = number }
variable "location" { type = any }

resource "panos_device_group" "example" {
	location = { panorama = {} }
	name = var.prefix
}

resource "panos_custom_vulnerability" "example" {
	depends_on = [panos_device_group.example]
	location = var.location
	name = var.name
	threatname = "threat"
	severity = "low"
	signature = {
		standard = [{
			name = "std"
			scope = "session"
			and_condition = [{
				name = "and"
				or_condition = [{
					name = "or"
					operator = {
						pattern_match = {
							context = "http-req-uri-path"
							pattern = "foo"
						}
					}
				}]
			}]
		}]
	}
}
`

func TestAccCustomVulnerability_Signature_Standard_OrderFree(t *testing.T) {
	t.Parallel()

	nameSuffix := acctest.RandStringFromCharSet(6, acctest.CharSetAlphaNum)
	prefix := fmt.Sprintf("test-acc-%s", nameSuffix)

	name := acctest.RandIntRange(41000, 45000)

	location := config.ObjectVariable(map[string]config.Variable{
		"device_group": config.ObjectVariable(map[string]config.Variable{
			"name": config.StringVariable(prefix),
		}),
	})

	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProviders,
		Steps: []resource.TestStep{
			{
				Config: customVulnerability_Signature_Standard_OrderFree_Tmpl,
				ConfigVariables: map[string]config.Variable{
					"prefix":   config.StringVariable(prefix),
					"name":     config.IntegerVariable(name),
					"location": location,
				},
				ConfigStateChecks: []statecheck.StateCheck{
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("name"),
						knownvalue.StringExact(strconv.Itoa(name)),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("signature").AtMapKey("standard").AtSliceIndex(0).AtMapKey("order_free"),
						knownvalue.Bool(true),
					),
				},
			},
		},
	})
}

const customVulnerability_Signature_Standard_OrderFree_Tmpl = `
variable "prefix" { type = string }
variable "name" { type = number }
variable "location" { type = any }

resource "panos_device_group" "example" {
	location = { panorama = {} }
	name = var.prefix
}

resource "panos_custom_vulnerability" "example" {
	depends_on = [panos_device_group.example]
	location = var.location
	name = var.name
	threatname = "threat"
	severity = "low"
	signature = {
		standard = [{
			name = "std"
			order_free = true
			and_condition = [{
				name = "and"
				or_condition = [{
					name = "or"
					operator = {
						pattern_match = {
							context = "http-req-uri-path"
							pattern = "foo"
						}
					}
				}]
			}]
		}]
	}
}
`

func TestAccCustomVulnerability_Signature_Standard_Operator_PatternMatch(t *testing.T) {
	t.Parallel()

	nameSuffix := acctest.RandStringFromCharSet(6, acctest.CharSetAlphaNum)
	prefix := fmt.Sprintf("test-acc-%s", nameSuffix)

	name := acctest.RandIntRange(41000, 45000)

	location := config.ObjectVariable(map[string]config.Variable{
		"device_group": config.ObjectVariable(map[string]config.Variable{
			"name": config.StringVariable(prefix),
		}),
	})

	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProviders,
		Steps: []resource.TestStep{
			{
				Config: customVulnerability_Signature_Standard_Operator_PatternMatch_Tmpl,
				ConfigVariables: map[string]config.Variable{
					"prefix":   config.StringVariable(prefix),
					"name":     config.IntegerVariable(name),
					"location": location,
				},
				ConfigStateChecks: []statecheck.StateCheck{
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("name"),
						knownvalue.StringExact(strconv.Itoa(name)),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("signature").AtMapKey("standard").AtSliceIndex(0).AtMapKey("and_condition").AtSliceIndex(0).AtMapKey("or_condition").AtSliceIndex(0).AtMapKey("operator"),
						knownvalue.ObjectExact(map[string]knownvalue.Check{
							"less_than":    knownvalue.Null(),
							"equal_to":     knownvalue.Null(),
							"greater_than": knownvalue.Null(),
							"pattern_match": knownvalue.ObjectExact(map[string]knownvalue.Check{
								"context":   knownvalue.StringExact("http-req-uri-path"),
								"pattern":   knownvalue.StringExact("foo"),
								"negate":    knownvalue.Bool(false),
								"qualifier": knownvalue.Null(),
							}),
						}),
					),
				},
			},
		},
	})
}

const customVulnerability_Signature_Standard_Operator_PatternMatch_Tmpl = `
variable "prefix" { type = string }
variable "name" { type = number }
variable "location" { type = any }

resource "panos_device_group" "example" {
	location = { panorama = {} }
	name = var.prefix
}

resource "panos_custom_vulnerability" "example" {
	depends_on = [panos_device_group.example]
	location = var.location
	name = var.name
	threatname = "threat"
	severity = "low"
	signature = {
		standard = [{
			name = "std"
			and_condition = [{
				name = "and"
				or_condition = [{
					name = "or"
					operator = {
						pattern_match = {
							context = "http-req-uri-path"
							pattern = "foo"
							negate = false
						}
					}
				}]
			}]
		}]
	}
}
`

func TestAccCustomVulnerability_Signature_Standard_Operator_LessThan(t *testing.T) {
	t.Parallel()

	nameSuffix := acctest.RandStringFromCharSet(6, acctest.CharSetAlphaNum)
	prefix := fmt.Sprintf("test-acc-%s", nameSuffix)

	name := acctest.RandIntRange(41000, 45000)

	location := config.ObjectVariable(map[string]config.Variable{
		"device_group": config.ObjectVariable(map[string]config.Variable{
			"name": config.StringVariable(prefix),
		}),
	})

	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProviders,
		Steps: []resource.TestStep{
			{
				Config: customVulnerability_Signature_Standard_Operator_LessThan_Tmpl,
				ConfigVariables: map[string]config.Variable{
					"prefix":   config.StringVariable(prefix),
					"name":     config.IntegerVariable(name),
					"location": location,
				},
				ConfigStateChecks: []statecheck.StateCheck{
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("name"),
						knownvalue.StringExact(strconv.Itoa(name)),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("signature").AtMapKey("standard").AtSliceIndex(0).AtMapKey("and_condition").AtSliceIndex(0).AtMapKey("or_condition").AtSliceIndex(0).AtMapKey("operator"),
						knownvalue.ObjectExact(map[string]knownvalue.Check{
							"less_than": knownvalue.ObjectExact(map[string]knownvalue.Check{
								"context":   knownvalue.StringExact("http-rsp-code"),
								"value":     knownvalue.Int64Exact(400),
								"qualifier": knownvalue.Null(),
							}),
							"equal_to":      knownvalue.Null(),
							"greater_than":  knownvalue.Null(),
							"pattern_match": knownvalue.Null(),
						}),
					),
				},
			},
		},
	})
}

const customVulnerability_Signature_Standard_Operator_LessThan_Tmpl = `
variable "prefix" { type = string }
variable "name" { type = number }
variable "location" { type = any }

resource "panos_device_group" "example" {
	location = { panorama = {} }
	name = var.prefix
}

resource "panos_custom_vulnerability" "example" {
	depends_on = [panos_device_group.example]
	location = var.location
	name = var.name
	threatname = "threat"
	severity = "low"
	signature = {
		standard = [{
			name = "std"
			and_condition = [{
				name = "and"
				or_condition = [{
					name = "or"
					operator = {
						less_than = {
							context = "http-rsp-code"
							value = 400
						}
					}
				}]
			}]
		}]
	}
}
`

func TestAccCustomVulnerability_Signature_Standard_Operator_EqualTo(t *testing.T) {
	t.Parallel()

	nameSuffix := acctest.RandStringFromCharSet(6, acctest.CharSetAlphaNum)
	prefix := fmt.Sprintf("test-acc-%s", nameSuffix)

	name := acctest.RandIntRange(41000, 45000)

	location := config.ObjectVariable(map[string]config.Variable{
		"device_group": config.ObjectVariable(map[string]config.Variable{
			"name": config.StringVariable(prefix),
		}),
	})

	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProviders,
		Steps: []resource.TestStep{
			{
				Config: customVulnerability_Signature_Standard_Operator_EqualTo_Tmpl,
				ConfigVariables: map[string]config.Variable{
					"prefix":   config.StringVariable(prefix),
					"name":     config.IntegerVariable(name),
					"location": location,
				},
				ConfigStateChecks: []statecheck.StateCheck{
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("name"),
						knownvalue.StringExact(strconv.Itoa(name)),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("signature").AtMapKey("standard").AtSliceIndex(0).AtMapKey("and_condition").AtSliceIndex(0).AtMapKey("or_condition").AtSliceIndex(0).AtMapKey("operator"),
						knownvalue.ObjectExact(map[string]knownvalue.Check{
							"less_than": knownvalue.Null(),
							"equal_to": knownvalue.ObjectExact(map[string]knownvalue.Check{
								"context":   knownvalue.StringExact("http-rsp-code"),
								"value":     knownvalue.Int64Exact(401),
								"negate":    knownvalue.Bool(false),
								"qualifier": knownvalue.Null(),
							}),
							"greater_than":  knownvalue.Null(),
							"pattern_match": knownvalue.Null(),
						}),
					),
				},
			},
		},
	})
}

const customVulnerability_Signature_Standard_Operator_EqualTo_Tmpl = `
variable "prefix" { type = string }
variable "name" { type = number }
variable "location" { type = any }

resource "panos_device_group" "example" {
	location = { panorama = {} }
	name = var.prefix
}

resource "panos_custom_vulnerability" "example" {
	depends_on = [panos_device_group.example]
	location = var.location
	name = var.name
	threatname = "threat"
	severity = "low"
	signature = {
		standard = [{
			name = "std"
			and_condition = [{
				name = "and"
				or_condition = [{
					name = "or"
					operator = {
						equal_to = {
							context = "http-rsp-code"
							value = 401
							negate = false
						}
					}
				}]
			}]
		}]
	}
}
`

func TestAccCustomVulnerability_Signature_Standard_Operator_GreaterThan(t *testing.T) {
	t.Parallel()

	nameSuffix := acctest.RandStringFromCharSet(6, acctest.CharSetAlphaNum)
	prefix := fmt.Sprintf("test-acc-%s", nameSuffix)

	name := acctest.RandIntRange(41000, 45000)

	location := config.ObjectVariable(map[string]config.Variable{
		"device_group": config.ObjectVariable(map[string]config.Variable{
			"name": config.StringVariable(prefix),
		}),
	})

	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProviders,
		Steps: []resource.TestStep{
			{
				Config: customVulnerability_Signature_Standard_Operator_GreaterThan_Tmpl,
				ConfigVariables: map[string]config.Variable{
					"prefix":   config.StringVariable(prefix),
					"name":     config.IntegerVariable(name),
					"location": location,
				},
				ConfigStateChecks: []statecheck.StateCheck{
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("name"),
						knownvalue.StringExact(strconv.Itoa(name)),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("signature").AtMapKey("standard").AtSliceIndex(0).AtMapKey("and_condition").AtSliceIndex(0).AtMapKey("or_condition").AtSliceIndex(0).AtMapKey("operator"),
						knownvalue.ObjectExact(map[string]knownvalue.Check{
							"less_than": knownvalue.Null(),
							"equal_to":  knownvalue.Null(),
							"greater_than": knownvalue.ObjectExact(map[string]knownvalue.Check{
								"context":   knownvalue.StringExact("http-rsp-code"),
								"value":     knownvalue.Int64Exact(402),
								"qualifier": knownvalue.Null(),
							}),
							"pattern_match": knownvalue.Null(),
						}),
					),
				},
			},
		},
	})
}

const customVulnerability_Signature_Standard_Operator_GreaterThan_Tmpl = `
variable "prefix" { type = string }
variable "name" { type = number }
variable "location" { type = any }

resource "panos_device_group" "example" {
	location = { panorama = {} }
	name = var.prefix
}

resource "panos_custom_vulnerability" "example" {
	depends_on = [panos_device_group.example]
	location = var.location
	name = var.name
	threatname = "threat"
	severity = "low"
	signature = {
		standard = [{
			name = "std"
			and_condition = [{
				name = "and"
				or_condition = [{
					name = "or"
					operator = {
						greater_than = {
							context = "http-rsp-code"
							value = 402
						}
					}
				}]
			}]
		}]
	}
}
`

func TestAccCustomVulnerability_Signature_Standard_Operator_EqualTo_Negate(t *testing.T) {
	t.Parallel()

	nameSuffix := acctest.RandStringFromCharSet(6, acctest.CharSetAlphaNum)
	prefix := fmt.Sprintf("test-acc-%s", nameSuffix)

	name := acctest.RandIntRange(41000, 45000)

	location := config.ObjectVariable(map[string]config.Variable{
		"device_group": config.ObjectVariable(map[string]config.Variable{
			"name": config.StringVariable(prefix),
		}),
	})

	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProviders,
		Steps: []resource.TestStep{
			{
				Config: customVulnerability_Signature_Standard_Operator_EqualTo_Negate_Tmpl,
				ConfigVariables: map[string]config.Variable{
					"prefix":   config.StringVariable(prefix),
					"name":     config.IntegerVariable(name),
					"location": location,
				},
				ConfigStateChecks: []statecheck.StateCheck{
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("name"),
						knownvalue.StringExact(strconv.Itoa(name)),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("signature").AtMapKey("standard").AtSliceIndex(0).AtMapKey("and_condition").AtSliceIndex(0).AtMapKey("or_condition").AtSliceIndex(0).AtMapKey("operator"),
						knownvalue.ObjectExact(map[string]knownvalue.Check{
							"less_than": knownvalue.Null(),
							"equal_to": knownvalue.ObjectExact(map[string]knownvalue.Check{
								"context":   knownvalue.StringExact("http-rsp-code"),
								"value":     knownvalue.Int64Exact(401),
								"negate":    knownvalue.Bool(true),
								"qualifier": knownvalue.Null(),
							}),
							"greater_than":  knownvalue.Null(),
							"pattern_match": knownvalue.Null(),
						}),
					),
				},
			},
		},
	})
}

const customVulnerability_Signature_Standard_Operator_EqualTo_Negate_Tmpl = `
variable "prefix" { type = string }
variable "name" { type = number }
variable "location" { type = any }

resource "panos_device_group" "example" {
	location = { panorama = {} }
	name = var.prefix
}

resource "panos_custom_vulnerability" "example" {
	depends_on = [panos_device_group.example]
	location = var.location
	name = var.name
	threatname = "threat"
	severity = "low"
	signature = {
		standard = [{
			name = "std"
			and_condition = [{
				name = "and"
				or_condition = [{
					name = "or"
					operator = {
						equal_to = {
							context = "http-rsp-code"
							value = 401
							negate = true
						}
					}
				}]
			}]
		}]
	}
}
`

func TestAccCustomVulnerability_Signature_Standard_Operator_PatternMatch_Negate(t *testing.T) {
	t.Parallel()

	nameSuffix := acctest.RandStringFromCharSet(6, acctest.CharSetAlphaNum)
	prefix := fmt.Sprintf("test-acc-%s", nameSuffix)

	name := acctest.RandIntRange(41000, 45000)

	location := config.ObjectVariable(map[string]config.Variable{
		"device_group": config.ObjectVariable(map[string]config.Variable{
			"name": config.StringVariable(prefix),
		}),
	})

	resource.Test(t, resource.TestCase{
		PreCheck:                 func() { testAccPreCheck(t) },
		ProtoV6ProviderFactories: testAccProviders,
		Steps: []resource.TestStep{
			{
				Config: customVulnerability_Signature_Standard_Operator_PatternMatch_Negate_Tmpl,
				ConfigVariables: map[string]config.Variable{
					"prefix":   config.StringVariable(prefix),
					"name":     config.IntegerVariable(name),
					"location": location,
				},
				ConfigStateChecks: []statecheck.StateCheck{
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("name"),
						knownvalue.StringExact(strconv.Itoa(name)),
					),
					statecheck.ExpectKnownValue(
						"panos_custom_vulnerability.example",
						tfjsonpath.New("signature").AtMapKey("standard").AtSliceIndex(0).AtMapKey("and_condition").AtSliceIndex(0).AtMapKey("or_condition").AtSliceIndex(0).AtMapKey("operator"),
						knownvalue.ObjectExact(map[string]knownvalue.Check{
							"less_than":    knownvalue.Null(),
							"equal_to":     knownvalue.Null(),
							"greater_than": knownvalue.Null(),
							"pattern_match": knownvalue.ObjectExact(map[string]knownvalue.Check{
								"context":   knownvalue.StringExact("http-req-uri-path"),
								"pattern":   knownvalue.StringExact("foo"),
								"negate":    knownvalue.Bool(true),
								"qualifier": knownvalue.Null(),
							}),
						}),
					),
				},
			},
		},
	})
}

const customVulnerability_Signature_Standard_Operator_PatternMatch_Negate_Tmpl = `
variable "prefix" { type = string }
variable "name" { type = number }
variable "location" { type = any }

resource "panos_device_group" "example" {
	location = { panorama = {} }
	name = var.prefix
}

resource "panos_custom_vulnerability" "example" {
	depends_on = [panos_device_group.example]
	location = var.location
	name = var.name
	threatname = "threat"
	severity = "low"
	signature = {
		standard = [{
			name = "std"
			and_condition = [{
				name = "and"
				or_condition = [{
					name = "or"
					operator = {
						pattern_match = {
							context = "http-req-uri-path"
							pattern = "foo"
							negate = true
						}
					}
				}]
			}]
		}]
	}
}
`
